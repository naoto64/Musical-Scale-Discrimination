<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム音階解析</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        #pitch { font-size: 2em; font-weight: bold; margin-top: 20px; }
        #chords { font-size: 1.5em; color: blue; }
    </style>
</head>
<body>
    <h1>リアルタイム音階解析</h1>
    <button onclick="startAudio()">録音開始</button>
    <div id="pitch">音階: なし</div>
    <div id="chords">和音: なし</div>

    <script>
        let audioContext, analyser, microphone, bufferLength, timeDomainData;

        async function startAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);

            bufferLength = analyser.fftSize;
            timeDomainData = new Float32Array(bufferLength);

            detectPitch();
        }

        function detectPitch() {
            analyser.getFloatTimeDomainData(timeDomainData);
            let fundamentalFreqs = autoCorrelate(timeDomainData, audioContext.sampleRate);

            let notes = fundamentalFreqs.map(f => getNoteFromFrequency(f)).filter(n => n);
            
            if (notes.length === 0) {
                document.getElementById("pitch").textContent = `音階: なし`;
                document.getElementById("chords").textContent = `和音: なし`;
            } else {
                document.getElementById("pitch").textContent = `音階: ${notes[0]}`;
                document.getElementById("chords").textContent = `和音: ${notes.slice(1, 5).join(" - ") || "なし"}`;
            }

            requestAnimationFrame(detectPitch);
        }

        function autoCorrelate(buffer, sampleRate) {
            let size = buffer.length;
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;
            let foundGoodCorrelation = false;
            let correlations = new Array(size);

            for (let i = 0; i < size; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / size);
            if (rms < 0.01) return []; // ノイズ除去

            let maxLag = size / 2;
            for (let lag = 0; lag < maxLag; lag++) {
                let correlation = 0;

                for (let i = 0; i < maxLag; i++) {
                    correlation += buffer[i] * buffer[i + lag];
                }

                correlation /= maxLag;
                correlations[lag] = correlation;

                if (correlation > 0.9 && correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = lag;
                    foundGoodCorrelation = true;
                }
            }

            if (!foundGoodCorrelation) return [];

            let fundamentalFreqs = [];
            let fundamentalFreq = sampleRate / bestOffset;

            if (fundamentalFreq > 20 && fundamentalFreq < 5000) {
                fundamentalFreqs.push(fundamentalFreq);
            }

            return fundamentalFreqs;
        }

        function getNoteFromFrequency(freq) {
            if (!freq) return null;

            const noteNames = ["ラ", "ラ#", "シ", "ド", "ド#", "レ", "レ#", "ミ", "ファ", "ファ#", "ソ", "ソ#"];
            let A4 = 440;
            let semitone = 12 * Math.log2(freq / A4);
            let noteIndex = Math.round(semitone) % 12;

            return noteNames[(noteIndex + 12) % 12];
        }
    </script>
</body>
</html>
